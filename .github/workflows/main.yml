name: Build OBS Floating Recorder Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # 安装构建工具
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        choco install 7zip -y
        
        # 下载OBS Studio开发包
        curl -L -o obs-deps.zip https://github.com/obsproject/obs-deps/releases/download/2022-08-02/win-deps-2022-08-02-x64.zip
        7z x obs-deps.zip -o"deps" -y
        
        # 下载OBS Studio源码（用于头文件）
        curl -L -o obs-studio.zip https://github.com/obsproject/obs-studio/archive/refs/tags/28.1.2.zip
        7z x obs-studio.zip -o"obs-src" -y
        
        # 下载Qt5 (使用较新的版本)
        curl -L -o qt-installer.exe https://download.qt.io/official_releases/online_installers/qt-unified-windows-x64-online.exe

    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
        install-deps: true

    - name: Create build directory
      run: mkdir build

    - name: Configure CMake
      working-directory: build
      env:
        Qt5_DIR: ${{ env.Qt5_DIR }}
      run: |
        cmake .. `
          -DCMAKE_BUILD_TYPE=Release `
          -DOBS_INCLUDE_DIR="${{ github.workspace }}/obs-src/obs-studio-28.1.2/libobs" `
          -DOBS_FRONTEND_INCLUDE_DIR="${{ github.workspace }}/obs-src/obs-studio-28.1.2/UI/obs-frontend-api" `
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/deps" `
          -DQt5_DIR="${{ env.Qt5_DIR }}"

    - name: Build plugin
      working-directory: build
      run: cmake --build . --config Release

    - name: List build artifacts
      working-directory: build
      run: dir

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-floating-recorder
        path: build/Release/obs-floating-recorder.dll
        if-no-files-found: error

  create-release:
    needs: build-windows
    if: github.event_name == 'release'
    runs-on: windows-latest
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: obs-floating-recorder.dll
