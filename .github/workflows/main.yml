name: Build OBS Floating Recorder Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # 安装构建工具
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        choco install 7zip ninja -y
        
        # 下载OBS Studio开发包（包含.lib文件）
        curl -L -o obs-deps.zip https://github.com/obsproject/obs-deps/releases/download/2022-08-02/win-deps-2022-08-02-x64.zip
        7z x obs-deps.zip -o"obs-deps" -y
        
        # 下载OBS Studio源码
        curl -L -o obs-src.zip https://github.com/obsproject/obs-studio/archive/refs/tags/28.1.2.zip
        7z x obs-src.zip -o"obs-src" -y
        
        # 下载预编译的OBS（用于运行时DLL）
        curl -L -o obs-studio.zip https://github.com/obsproject/obs-studio/releases/download/28.1.2/obs-studio-28.1.2-windows-x64.zip
        7z x obs-studio.zip -o"obs-install" -y

    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
        install-deps: true

    - name: Create build directory
      run: mkdir build

    - name: Configure CMake
      working-directory: build
      env:
        Qt5_DIR: ${{ env.Qt5_DIR }}
      run: |
        cmake .. `
          -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_AUTOMOC=ON `
          -DOBS_DEPS_PATH="${{ github.workspace }}/obs-deps" `
          -DOBS_INSTALL_PATH="${{ github.workspace }}/obs-install/obs-studio" `
          -DOBS_INCLUDE_DIR="${{ github.workspace }}/obs-src/obs-studio-28.1.2/libobs" `
          -DOBS_FRONTEND_INCLUDE_DIR="${{ github.workspace }}/obs-src/obs-studio-28.1.2/UI/obs-frontend-api" `
          -DQt5_DIR="${{ env.Qt5_DIR }}"

    - name: Build plugin
      working-directory: build
      run: cmake --build . --config Release

    - name: List build artifacts
      working-directory: build
      run: dir

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-floating-recorder
        path: build/obs-floating-recorder.dll
        if-no-files-found: error
